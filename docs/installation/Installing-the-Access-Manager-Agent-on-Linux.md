# Installing the Access Manager Agent on Linux

## Prerequisites
The Access Manager Agent makes use of the `chpasswd` tool, built into most linux distributions. Ensure this tool is available before installing the agent.

The agent must be able to validate the AMS server certificate. If you are using a self-signed certificate, consult the guide relevant to your OS for how to add the certificate to the OS trust store. You can use openssl to validate the trust state of the certificate using the `openssl verify cert.crt` command.

The agent itself runs using systemd, and as it requires access to reset the root password, must be run as the root user.

### Dotnet Core requirements
The agent is build using dotnet core 3.1. Ensure the distribution you are using is supported See the [Microsoft guide for supported operating systems for dotnet core 3.1](https://github.com/dotnet/core/blob/main/release-notes/3.1/3.1-supported-os.md) for more information.

While you do not need to install the dotnet package itself, as the agent contains all the dotnet components it needs to run, there are certain dependencies required by dotnet, that if are not present, will prevent the agent from running. If you run into this issue, you may wish to install the dotnet 3.1 package to automatically obtain the dependencies, or [review the list of dependencies](https://docs.microsoft.com/en-us/dotnet/core/install/linux-scripted-manual) that dotnet requires, and install these yourself.

## Agent installation
### Installing the agent on RPM-based distributions
Use the appropriate package management tool to install the agent
```shell
yum install /path/to/package.rpm
```

Continue to the `Configuring the agent` section below.

### Installing the agent on Debian-based distributions
Use the appropriate package management tool to install the agent
```shell
apt install /path/to/package.deb
```

Continue to the `Configuring the agent` section below.

### Installing the agent from the .tar.gz archive
Extract the archive to the root file system, allowing the files to be placed in their correct location. See the `File location` section below for more information on what files get unpacked and where.

Run the following command to register the service with systemd

```shell
/opt/LithnetAccessManagerAgent/LithnetAccessManagerAgent --install
```

Continue to the `Configuring the agent` section below.

## Configuring the agent
Once the package is installed, it must be configured to talk to your AMS server. You can run the following command to perform an interactive installation

```shell
/opt/LithnetAccessManagerAgent/LithnetAccessManagerAgent --setup
```

To perform a non-interactive installation, use the following command, replacing the server name, and registration key as appropriate. You can generate new registration keys using the AMS configuration tool.

```shell
/opt/LithnetAccessManagerAgent/LithnetAccessManagerAgent --server ams.lithnet.local --registration-key XXXX
```

Check the log using the instructions in the `Viewing the log files` section below to ensure the agent registered correctly.

## Restarting the agent
The Lithnet Access Manager Agent runs as a daemon using systemd. You can use standard systemd commands to start, stop and restart the agent.

```shell
systemctl restart LithnetAccessManagerAgent
```

## Viewing log files
The agent logs are viewed using `journalctl`. 

To show all events in the log use the following command
```shell
journalctl -u LithnetAccessManagerAgent -p 7 -a
```

To show a live stream of log messages use the following command
```shell
journalctl -u LithnetAccessManagerAgent -p 7 -a -f
```

## File locations
The agent creates and uses the following files and folders.

`/etc/LithnetAccessManagerAgent.conf` - The main configuration file for the application. This contains the AMS server name and other settings relevant to the application.

`/var/lib/LithnetAccessManagerAgent/LithnetAccessManagerAgent.state` - This contains  information used by the agent to store its current state information. This file should not be modified. It is generated by the app when it is run, and is not part of the installation package.

`/opt/LithnetAccessManagerAgent` - This directory contains the application binary files.

`/etc/systemd/system/LithnetAccessManagerAgent.service` - The systemd entry for the agent