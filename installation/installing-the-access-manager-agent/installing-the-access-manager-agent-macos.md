# Installing the Access Manager Agent on macOS

## Prerequisites

The agent must be able to validate the AMS server certificate. If you are using a self-signed certificate, you'll need to [add this certificate](https://support.apple.com/en-au/guide/keychain-access/kyca2431/mac) to the system keychain, and [configure it to be trusted](https://support.apple.com/en-au/guide/keychain-access/kyca11871/mac).

The agent itself runs using launchd, and as it requires access to reset the root password, must be run as the root user.

### OS requirements

The agent requires OSX 10.15 or later. Packages are available for both Intel and Arm64 Macs.

## Installing the agent

You can open the package from finder, or use the `installer` command line tool to install the package

```shell
# Download installer packages
if [[ $(uname -m) == 'arm64' ]]; then
    curl -fssL https://packages.lithnet.io/macos/access-manager-agent/v2.0/arm64/stable -o accessmanageragent.pkg
else
    curl -fssL https://packages.lithnet.io/macos/access-manager-agent/v2.0/x64/stable -o accessmanageragent.pkg
fi
​
# Check the installer signature
pkgutil --check-signature accessmanageragent.pkg
# Expected output:
# # Package "accessmanageragent.{arm64|x64}.pkg":
# #    Status: signed by a developer certificate issued by Apple for distribution
# #    Notarization: trusted by the Apple notary service
# #    Signed with a trusted timestamp on: 2022-10-23 10:37:42 +0000
# #    Certificate Chain:
# #     1. Developer ID Installer: Lithnet Pty Ltd (5DK86QQXK3)
# #        Expires: 2026-08-05 23:12:36 +0000
# #        SHA256 Fingerprint:
# #            F9 B6 D5 17 02 11 8B 47 19 25 15 6A F7 46 61 41 49 36 55 56 DD 21
# #            31 47 FB 0A E8 DC 36 8E 50 1F
# #        ------------------------------------------------------------------------
# #     2. Developer ID Certification Authority
# #        Expires: 2027-02-01 22:12:15 +0000
# #        SHA256 Fingerprint:
# #            7A FC 9D 01 A6 2F 03 A2 DE 96 37 93 6D 4A FE 68 09 0D 2D E1 8D 03
# #            F2 9C 88 CF B0 B1 BA 63 58 7F
# #        ------------------------------------------------------------------------
# #     3. Apple Root CA
# #        Expires: 2035-02-09 21:40:36 +0000
# #        SHA256 Fingerprint:
# #            B0 B1 73 0E CB C7 FF 45 05 14 2C 49 F1 29 5E 6E DA 6B CA ED 7E 2C
# #            68 C5 BE 91 B5 A1 10 01 F0 24
​
# Install the agent
sudo installer -pkg accessmanageragent.pkg -target / 
```

## Configuring the agent

Once the package is installed, it must be configured to talk to your AMS server. You can run the following command to perform an interactive installation

```shell
sudo /Library/Application\ Support/Lithnet/AccessManagerAgent/Core/Lithnet.AccessManager.Agent --setup
```

To perform a non-interactive installation, use the following command, replacing the server name, and registration key as appropriate. You can generate new registration keys using the AMS configuration tool.

```shell
sudo /Library/Application\ Support/Lithnet/AccessManagerAgent/Core/Lithnet.AccessManager.Agent --server ams.lithnet.local --registration-key XXXX
```

Check the log using the instructions in the `Viewing the log files` section below to ensure the agent registered correctly.

## Restarting the agent

The Lithnet Access Manager Agent runs as a daemon using launchd. You can use standard launchd commands to start, stop and restart the agent.

```shell
sudo launchctl kickstart -k system/io.lithnet.accessmanager.agent
```

## Uninstalling the agent

You can use the uninstallation script provided to remove the agent from the computer.

```shell
sudo /Library/Application\ Support/Lithnet/AccessManagerAgent/Core/Lithnet.AccessManager.Agent/uninstall.sh
```

## Viewing log files

The agent logs can be viewed using the `Console` app, or using the command line

To show all events in the log use the following command

```shell
tail /Library/Logs/Lithnet/AccessManagerAgent/LithnetAccessManagerAgent.log
```

To show a live stream of log messages use the following command

```shell
tail -f /Library/Logs/Lithnet/AccessManagerAgent/LithnetAccessManagerAgent.log
```

## File locations

The agent creates and uses the following files and folders.

`/Library/Application Support/Lithnet/AccessManagerAgent/Configuration/LithnetAccessManagerAgent.conf` - The main configuration file for the application. This contains the AMS server name and other settings relevant to the application.

`/Library/Application Support/Lithnet/AccessManagerAgent/Configuration/LithnetAccessManagerAgent.state` - This contains information used by the agent to store its current state information. This file should not be modified. It is generated by the app when it is run, and is not part of the installation package.

`/Library/Application Support/Lithnet/AccessManagerAgent/Core` - This directory contains the application binary files.

`/Library/Logs/Lithnet/AccessManagerAgent/` - This directory contains the agent log files.

`/Library/LaunchDaemons/io.lithnet.accessmanager.agent.plist` - The launchd entry for the agent, symlinked from the application directory.
